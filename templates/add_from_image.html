{% extends "base.html" %}

{% block title %}ThÃªm tá»« áº¢nh{% endblock %}

{% block content %}
<h1 class="mb-4">ğŸ“¸ ThÃªm Äáº·t phÃ²ng tá»« áº¢nh</h1>
<p>Sao chÃ©p má»™t áº£nh chá»¥p mÃ n hÃ¬nh danh sÃ¡ch Ä‘áº·t phÃ²ng vÃ  dÃ¡n (Ctrl+V) vÃ o khung bÃªn dÆ°á»›i.</p>

<div id="paste-area" class="p-5 border-2 border-dashed rounded-3 text-center bg-light mb-4" style="border-style: dashed;">
    <h4>DÃ¡n áº£nh vÃ o Ä‘Ã¢y</h4>
</div>

<div id="results-area" class="d-none">
    <h2 class="mb-3">Káº¿t quáº£ trÃ­ch xuáº¥t</h2>
    <div id="spinner" class="text-center my-4 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Äang xá»­ lÃ½...</span>
        </div>
        <p>AI Ä‘ang phÃ¢n tÃ­ch áº£nh, vui lÃ²ng chá»...</p>
    </div>
    <div id="error-message" class="alert alert-danger d-none"></div>
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>TÃªn ngÆ°á»i Ä‘áº·t</th>
                <th>NgÃ y Ä‘áº¿n</th>
                <th>NgÃ y Ä‘i</th>
                <th>TÃªn chá»— nghá»‰</th>
                <th>Tá»•ng thanh toÃ¡n</th>
                <th>Hoa há»“ng</th>
            </tr>
        </thead>
        <tbody id="results-tbody">
            <!-- Dá»¯ liá»‡u tá»« AI sáº½ Ä‘Æ°á»£c chÃ¨n vÃ o Ä‘Ã¢y -->
        </tbody>
    </table>

    <form action="{{ url_for('save_extracted_bookings') }}" method="POST" id="save-form" class="d-none">
        <input type="hidden" name="extracted_json" id="extracted_json_input">
        <button type="submit" class="btn btn-success mt-3 w-100">
            <i class="fas fa-save"></i> LÆ°u cÃ¡c Ä‘áº·t phÃ²ng nÃ y vÃ o Google Sheets
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('paste', async function (event) {
    const pasteArea = document.getElementById('paste-area');
    const resultsArea = document.getElementById('results-area');
    const resultsTbody = document.getElementById('results-tbody');
    const spinner = document.getElementById('spinner');
    const errorMessage = document.getElementById('error-message');

    // Láº¥y dá»¯ liá»‡u áº£nh tá»« clipboard
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    let imageFile = null;
    for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
            imageFile = item.getAsFile();
            break;
        }
    }

    if (imageFile) {
        // Hiá»ƒn thá»‹ khu vá»±c káº¿t quáº£ vÃ  spinner
        resultsArea.classList.remove('d-none');
        spinner.classList.remove('d-none');
        errorMessage.classList.add('d-none');
        resultsTbody.innerHTML = ''; // XÃ³a káº¿t quáº£ cÅ©

        // Chuyá»ƒn áº£nh sang Base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            const image_b64 = e.target.result;
            
            try {
                // Gá»­i Base64 Ä‘áº¿n server
                const response = await fetch("{{ url_for('process_pasted_image') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_b64: image_b64 })
                });

                spinner.classList.add('d-none'); // áº¨n spinner

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh tá»« server.');
                }

                const extractedData = await response.json();

                // Kiá»ƒm tra náº¿u AI tráº£ vá» lá»—i
                if (extractedData.length > 0 && extractedData[0].error) {
                    throw new Error(extractedData[0].error);
                }

                // Hiá»ƒn thá»‹ káº¿t quáº£ trong báº£ng
                let tableContent = '';
                extractedData.forEach(booking => {
                    tableContent += `
                        <tr>
                            <td>${booking.guest_name || 'N/A'}</td>
                            <td>${booking.check_in_date || 'N/A'}</td>
                            <td>${booking.check_out_date || 'N/A'}</td>
                            <td>${booking.room_type || 'N/A'}</td>
                            <td>${booking.total_payment || 0}</td>
                            <td>${booking.commission || 0}</td>
                        </tr>
                    `;
                });
                resultsTbody.innerHTML = tableContent;

                // LÆ°u chuá»—i JSON vÃ o input áº©n Ä‘á»ƒ gá»­i Ä‘i
                document.getElementById('extracted_json_input').value = JSON.stringify(extractedData);

            } catch (error) {
                spinner.classList.add('d-none');
                errorMessage.textContent = 'Lá»—i: ' + error.message;
                errorMessage.classList.remove('d-none');
            }
        };
        reader.readAsDataURL(imageFile);
    }
});
</script>
{% endblock %}