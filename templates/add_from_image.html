{% extends "base.html" %}

{% block title %}Th√™m ƒê·∫∑t ph√≤ng t·ª´ ·∫¢nh{% endblock %}

{% block content %}
    <h1 class="mb-4">üñºÔ∏è Th√™m ƒê·∫∑t ph√≤ng t·ª´ ·∫¢nh</h1>
    <p class="lead mb-4">T·∫£i l√™n ·∫£nh ch·ª•p m√†n h√¨nh danh s√°ch ƒë·∫∑t ph√≤ng ƒë·ªÉ AI t·ª± ƒë·ªông tr√≠ch xu·∫•t th√¥ng tin.</p>

    <div class="row">
        <!-- C·ªôt t·∫£i file -->
        <div class="col-md-6">
            <div class="card bg-light mb-4 h-100">
                <div class="card-body">
                    <h5 class="card-title">C√°ch 1: T·∫£i file ·∫£nh l√™n</h5>
                    <form id="upload-image-form" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="image_file_input" class="form-label">Ch·ªçn file ·∫£nh</label>
                            <input type="file" name="image_file" id="image_file_input" class="form-control" accept="image/*">
                        </div>
                        <button id="extract-button" type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Tr√≠ch xu·∫•t t·ª´ File
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- C·ªôt d√°n ·∫£nh -->
        <div class="col-md-6">
            <div class="card bg-light mb-4 h-100">
                <div class="card-body">
                    <h5 class="card-title">C√°ch 2: D√°n ·∫£nh tr·ª±c ti·∫øp</h5>
                    <div id="paste-area" class="d-flex justify-content-center align-items-center border-dashed" style="height: 150px; border: 2px dashed #ccc; cursor: pointer;">
                        <span id="paste-placeholder">D√°n ·∫£nh v√†o ƒë√¢y (Ctrl+V)</span>
                        <img id="pasted-image-preview" src="#" alt="Pasted Image Preview" class="d-none" style="max-height: 100%; max-width: 100%;"/>
                    </div>
                     <div id="paste-spinner" class="text-center mt-2 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>ƒêang x·ª≠ l√Ω...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="results-card" class="card d-none">
        <div class="card-body">
            <h5 class="card-title">B∆∞·ªõc 2: X√°c nh·∫≠n v√† L∆∞u</h5>
            <p>ƒê√¢y l√† d·ªØ li·ªáu AI ƒë√£ tr√≠ch xu·∫•t ƒë∆∞·ª£c. Vui l√≤ng ki·ªÉm tra v√† nh·∫•n l∆∞u.</p>
            
            <form id="save-extracted-form" method="POST" action="{{ url_for('save_extracted_bookings') }}">
                <input type="hidden" id="extracted-json-input" name="extracted_data_json">
                
                <div id="results-table" class="table-responsive">
                    <!-- B·∫£ng s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS -->
                </div>

                <button type="submit" class="btn btn-success mt-3">L∆∞u c√°c ƒë·∫∑t ph√≤ng n√†y</button>
            </form>
        </div>
    </div>
    
    <div id="initial-data-container" data-extracted="{{ extracted_data | tojson | safe }}"></div>
{% endblock %}

{% block scripts %}
<script>
    // H√†m chung ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ tr√≠ch xu·∫•t
    function displayExtractedData(data) {
        const resultsCard = document.getElementById('results-card');
        const tableContainer = document.getElementById('results-table');
        const jsonInput = document.getElementById('extracted-json-input');

        if (!data || data.length === 0 || (data && data.error)) {
            let errorMessage = data && data.error ? data.error : 'Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c d·ªØ li·ªáu ho·∫∑c ·∫£nh kh√¥ng h·ª£p l·ªá.';
            tableContainer.innerHTML = `<p class="text-danger">${errorMessage}</p>`;
            resultsCard.classList.remove('d-none');
            jsonInput.value = ''; 
            return;
        }
        
        jsonInput.value = JSON.stringify(data);

        let tableHTML = '<table class="table table-bordered"><thead class="table-dark"><tr>';
        const headers = Object.keys(data[0]);
        headers.forEach(key => tableHTML += `<th>${key}</th>`);
        tableHTML += '</tr></thead><tbody>';

        data.forEach(row => {
            tableHTML += '<tr>';
            headers.forEach(key => {
                const value = row[key] !== null && row[key] !== undefined ? row[key] : '';
                tableHTML += `<td>${value}</td>`
            });
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
        resultsCard.classList.remove('d-none');
    }

    // Listener cho s·ª± ki·ªán t·∫£i trang
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ server-side (n·∫øu c√≥)
        const initialDataContainer = document.getElementById('initial-data-container');
        const initialData = initialDataContainer.getAttribute('data-extracted');
        if (initialData) {
            try {
                const serverData = JSON.parse(initialData);
                if (serverData) {
                    displayExtractedData(serverData);
                }
            } catch (e) {
                console.error("L·ªói ph√¢n t√≠ch d·ªØ li·ªáu ban ƒë·∫ßu:", e);
            }
        }

        // 2. X·ª≠ l√Ω s·ª± ki·ªán d√°n ·∫£nh
        const pasteArea = document.getElementById('paste-area');
        const pastePlaceholder = document.getElementById('paste-placeholder');
        const preview = document.getElementById('pasted-image-preview');
        const pasteSpinner = document.getElementById('paste-spinner');
        
        pasteArea.addEventListener('paste', async (event) => {
            event.preventDefault();
            pasteSpinner.classList.remove('d-none');
            pastePlaceholder.classList.add('d-none');
            preview.classList.add('d-none');

            const items = (event.clipboardData || window.clipboardData).items;
            let file = null;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    file = item.getAsFile();
                    break;
                }
            }

            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result;
                    preview.src = base64Image;
                    preview.classList.remove('d-none');
                    
                    try {
                        const response = await fetch('/api/process_pasted_image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image_b64: base64Image })
                        });
                        
                        pasteSpinner.classList.add('d-none');
                        const resultData = await response.json();
                        displayExtractedData(resultData);

                    } catch (error) {
                        console.error('Error processing pasted image:', error);
                        displayExtractedData({error: 'L·ªói giao ti·∫øp v·ªõi m√°y ch·ªß.'});
                        pasteSpinner.classList.add('d-none');
                    }
                };
                reader.readAsDataURL(file);
            } else {
                pasteSpinner.classList.add('d-none');
                pastePlaceholder.classList.remove('d-none');
                displayExtractedData({error: 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ·∫£nh trong clipboard.'});
            }
        });

        // 3. X·ª≠ l√Ω spinner cho form t·∫£i file
        const uploadForm = document.getElementById('upload-image-form');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                const button = document.getElementById('extract-button');
                const spinner = button.querySelector('.spinner-border');
                if (button) button.disabled = true;
                if (spinner) spinner.classList.remove('d-none');
            });
        }
    });
</script>
{% endblock %}