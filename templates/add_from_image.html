{% extends "base.html" %}

{% block title %}Thêm từ Ảnh{% endblock %}

{% block content %}
<h1 class="mb-4">📸 Thêm Đặt phòng từ Ảnh</h1>
<p>Sao chép một ảnh chụp màn hình danh sách đặt phòng và dán (Ctrl+V) vào khung bên dưới.</p>

<div id="paste-area" class="p-5 border-2 border-dashed rounded-3 text-center bg-light mb-4" style="border-style: dashed;">
    <h4>Dán ảnh vào đây</h4>
</div>

<div id="results-area" class="d-none">
    <h2 class="mb-3">Kết quả trích xuất</h2>
    <div id="spinner" class="text-center my-4 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang xử lý...</span>
        </div>
        <p>AI đang phân tích ảnh, vui lòng chờ...</p>
    </div>
    <div id="error-message" class="alert alert-danger d-none"></div>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Tên khách</th>
                <th>Mã ĐP</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Loại phòng</th>
                <th>Tổng tiền</th>
            </tr>
        </thead>
        <tbody id="results-tbody">
            <!-- Kết quả sẽ được chèn vào đây bằng JavaScript -->
        </tbody>
    </table>
    <!-- Form để lưu sẽ được thêm sau -->
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('paste', async function (event) {
    const pasteArea = document.getElementById('paste-area');
    const resultsArea = document.getElementById('results-area');
    const resultsTbody = document.getElementById('results-tbody');
    const spinner = document.getElementById('spinner');
    const errorMessage = document.getElementById('error-message');

    // Lấy dữ liệu ảnh từ clipboard
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    let imageFile = null;
    for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
            imageFile = item.getAsFile();
            break;
        }
    }

    if (imageFile) {
        // Hiển thị khu vực kết quả và spinner
        resultsArea.classList.remove('d-none');
        spinner.classList.remove('d-none');
        errorMessage.classList.add('d-none');
        resultsTbody.innerHTML = ''; // Xóa kết quả cũ

        // Chuyển ảnh sang Base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            const image_b64 = e.target.result;
            
            try {
                // Gửi Base64 đến server
                const response = await fetch("{{ url_for('process_pasted_image') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_b64: image_b64 })
                });

                spinner.classList.add('d-none'); // Ẩn spinner

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Lỗi không xác định từ server.');
                }

                const extractedData = await response.json();

                // Kiểm tra nếu AI trả về lỗi
                if (extractedData.length > 0 && extractedData[0].error) {
                    throw new Error(extractedData[0].error);
                }

                // Hiển thị kết quả trong bảng
                extractedData.forEach(booking => {
                    const row = `<tr>
                        <td>${booking.guest_name || 'N/A'}</td>
                        <td>${booking.booking_id || 'N/A'}</td>
                        <td>${booking.check_in_date || 'N/A'}</td>
                        <td>${booking.check_out_date || 'N/A'}</td>
                        <td>${booking.room_type || 'N/A'}</td>
                        <td>${booking.total_payment || 'N/A'}</td>
                    </tr>`;
                    resultsTbody.innerHTML += row;
                });

            } catch (error) {
                spinner.classList.add('d-none');
                errorMessage.textContent = 'Lỗi: ' + error.message;
                errorMessage.classList.remove('d-none');
            }
        };
        reader.readAsDataURL(imageFile);
    }
});
</script>
{% endblock %}