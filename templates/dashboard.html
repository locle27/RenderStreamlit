{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- H√†ng ti√™u ƒë·ªÅ v√† b·ªô l·ªçc ng√†y -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2">üìä Dashboard</h1>
        <form method="get" action="{{ url_for('dashboard') }}" class="d-flex align-items-center">
            <div class="me-2">
                <label for="start_date" class="form-label visually-hidden">T·ª´ ng√†y</label>
                <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="me-2">
                <label for="end_date" class="form-label visually-hidden">ƒê·∫øn ng√†y</label>
                <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <button type="submit" class="btn btn-sm btn-primary">L·ªçc</button>
        </form>
    </div>

    <!-- H√†ng th·∫ª ch·ªâ s·ªë ch√≠nh -->
    <div class="row g-2 mb-3">
        <div class="col">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title">T·ªïng Doanh thu</h5>
                    <p class="card-text fs-4 fw-bold">{{ "{:,.0f}ƒë".format(total_revenue) }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h5 class="card-title">T·ªïng S·ªë kh√°ch</h5>
                    <p class="card-text fs-4 fw-bold">{{ total_guests }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì Doanh thu H√†ng th√°ng -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä Bi·ªÉu ƒë·ªì Doanh thu H√†ng th√°ng</h5>
                </div>
                <div class="card-body">
                    <div id="monthly-revenue-chart" data-chart-json="{{ monthly_revenue_chart_json|tojson|safe }}"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì C·ªôt So s√°nh Doanh thu -->
    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìà So s√°nh Doanh thu H√†ng th√°ng</h5>
                </div>
                <div class="card-body">
                    <div id="monthly-revenue-bar-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- H√†ng b·∫£ng d·ªØ li·ªáu -->
    <div class="row g-2">
        <!-- C·ªôt b√™n tr√°i cho c√°c b·∫£ng -->
        <div class="col-lg-8">
             <!-- B·∫£ng Doanh thu h√†ng th√°ng v√† Doanh thu ƒë√£ thu -->
             <div class="row g-2">
                <div class="col-md-6">
                     <div class="card h-100">
                         <div class="card-header">Doanh thu h√†ng th√°ng (T·∫•t c·∫£)</div>
                         <div class="card-body table-container">
                             <table class="table table-sm table-striped">
                                 <thead class="sticky-header">
                                  <tr>
                                     <th><a href="{{ url_for('dashboard', sort_by='Th√°ng', sort_order='desc' if current_sort_order == 'asc' else 'asc') }}">Th√°ng {{ '‚ñ≤' if current_sort_by == 'Th√°ng' and current_sort_order == 'asc' else '‚ñº' }}</a></th>
                                     <th class="text-end"><a href="{{ url_for('dashboard', sort_by='Doanh thu', sort_order='desc' if current_sort_order == 'asc' else 'asc') }}">Doanh thu {{ '‚ñ≤' if current_sort_by == 'Doanh thu' and current_sort_order == 'asc' else '‚ñº' }}</a></th>
                                  </tr>
                                 </thead>
                                 <tbody>
                                  {% for row in monthly_revenue_list %}
                                  <tr>
                                      <td>{{ row['Th√°ng'] }}</td>
                                      <td class="text-end fw-bold">{{ "{:,.0f}".format(row['Doanh thu']) }}ƒë</td>
                                  </tr>
                                  {% endfor %}
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
                 <div class="col-md-6">
                     <div class="card h-100">
                         <div class="card-header bg-success-subtle">Doanh thu ƒê√£ thu (T·∫•t c·∫£)</div>
                         <div class="card-body table-container">
                             <table class="table table-sm table-striped">
                                 <thead class="sticky-header">
                                  <tr>
                                      <th>Th√°ng</th>
                                      <th class="text-end">Doanh thu ƒë√£ thu</th>
                                  </tr>
                                 </thead>
                                 <tbody>
                                     {% for row in monthly_collected_revenue_list %}
                                  <tr>
                                      <td>{{ row['Th√°ng'] }}</td>
                                      <td class="text-end fw-bold text-success">{{ "{:,.0f}".format(row['Doanh thu ƒë√£ thu']) }}ƒë</td>
                                  </tr>
                                  {% endfor %}
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
        <!-- C·ªôt b√™n ph·∫£i cho bi·ªÉu ƒë·ªì v√† b·∫£ng ng∆∞·ªùi thu ti·ªÅn -->
        <div class="col-lg-4">
            <div class="row g-2">
                <div class="col-12">
                    <div class="card h-100">
                        <div class="card-body">
                             <div id="collector-chart" data-chart-json="{{ collector_chart_json|tojson|safe }}"></div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card h-100">
                        <div class="card-header">Doanh thu theo Ng∆∞·ªùi thu ti·ªÅn</div>
                        <div class="card-body table-container">
                            <table class="table table-sm table-striped">
                                <thead class="sticky-header">
                                    <tr>
                                        <th>Ng∆∞·ªùi thu ti·ªÅn</th>
                                        <th class="text-end">T·ªïng thanh to√°n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in collector_revenue_list %}
                                    <tr>
                                        <td>{{ row['Ng∆∞·ªùi thu ti·ªÅn'] }}</td>
                                        <td class="text-end">{{ "{:,.0f}ƒë".format(row['T·ªïng thanh to√°n']) }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table-container { max-height: 300px; overflow-y: auto; }
    .sticky-header th { position: sticky; top: 0; z-index: 2; background-color: white !important; box-shadow: inset 0 -2px 0 #dee2e6; }
    .sticky-header th a { text-decoration: none; color: inherit; }
</style>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded and parsed. Initializing charts...");

        // Bi·ªÉu ƒë·ªì ng∆∞·ªùi thu ti·ªÅn
        try {
            const collectorChartDiv = document.getElementById('collector-chart');
            const collectorChartJsonString = collectorChartDiv.dataset.chartJson;
            console.log("Collector chart data string:", collectorChartJsonString.substring(0, 100) + '...');
            if (collectorChartJsonString && collectorChartJsonString.length > 2) { // Check for more than empty {}
                const collectorChartData = JSON.parse(collectorChartJsonString);
                if (collectorChartData && collectorChartData.data && collectorChartData.data[0].values.length > 0) {
                    Plotly.newPlot('collector-chart', collectorChartData.data, collectorChartData.layout, {responsive: true});
                    console.log("Collector chart rendered.");
                } else {
                    console.log("Collector chart data is empty, not rendering.");
                }
            }
        } catch (e) {
            console.error("Error rendering collector chart:", e);
        }

        // Bi·ªÉu ƒë·ªì doanh thu h√†ng th√°ng (line chart)
        try {
            const monthlyRevenueChartDiv = document.getElementById('monthly-revenue-chart');
            const monthlyRevenueChartJsonString = monthlyRevenueChartDiv.dataset.chartJson;
            console.log("Monthly revenue chart data string:", monthlyRevenueChartJsonString.substring(0, 100) + '...');
            if (monthlyRevenueChartJsonString && monthlyRevenueChartJsonString.length > 2) {
                const monthlyRevenueChartData = JSON.parse(monthlyRevenueChartJsonString);
                if (monthlyRevenueChartData && monthlyRevenueChartData.data) {
                     Plotly.newPlot('monthly-revenue-chart', monthlyRevenueChartData.data, monthlyRevenueChartData.layout, {responsive: true});
                     console.log("Monthly revenue chart rendered.");
                } else {
                    console.log("Monthly revenue chart data is empty, not rendering.");
                }
            }
        } catch(e) {
            console.error("Error rendering monthly revenue chart:", e);
        }

        // Bi·ªÉu ƒë·ªì c·ªôt so s√°nh doanh thu h√†ng th√°ng
        try {
            const monthlyRevenueData = {{ monthly_revenue_list|tojson|safe }};
            console.log("Monthly revenue data for bar chart:", monthlyRevenueData);
            
            if (monthlyRevenueData && monthlyRevenueData.length > 0) {
                const months = monthlyRevenueData.map(item => item['Th√°ng']);
                const revenues = monthlyRevenueData.map(item => item['Doanh thu']);
                
                const barChartData = [{
                    x: months,
                    y: revenues,
                    type: 'bar',
                    name: 'Doanh thu',
                    marker: {
                        color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#FFB347', '#87CEEB', '#F0E68C', '#FFA07A', '#20B2AA'],
                        line: {
                            color: '#2c3e50',
                            width: 1
                        }
                    },
                    text: revenues.map(r => (r / 1000000).toFixed(1) + 'M'),
                    textposition: 'auto',
                    hovertemplate: '<b>%{x}</b><br>' +
                                  'Doanh thu: %{y:,.0f}ƒë<br>' +
                                  '<extra></extra>'
                }];

                const barChartLayout = {
                    title: {
                        text: 'üí∞ So s√°nh Doanh thu theo Th√°ng',
                        x: 0.5,
                        font: {
                            size: 18,
                            family: 'Arial, sans-serif',
                            color: '#2c3e50'
                        }
                    },
                    xaxis: {
                        title: 'Th√°ng',
                        tickangle: -45,
                        showgrid: true,
                        gridcolor: 'rgba(128,128,128,0.2)',
                        showline: true,
                        linecolor: 'rgba(128,128,128,0.5)'
                    },
                    yaxis: {
                        title: 'Doanh thu (VND)',
                        tickformat: ',.0f',
                        showgrid: true,
                        gridcolor: 'rgba(128,128,128,0.2)',
                        showline: true,
                        linecolor: 'rgba(128,128,128,0.5)'
                    },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: {
                        family: 'Arial, sans-serif',
                        size: 12,
                        color: '#2c3e50'
                    },
                    margin: {
                        l: 80,
                        r: 30,
                        t: 80,
                        b: 100
                    },
                    height: 400,
                    showlegend: false
                };

                Plotly.newPlot('monthly-revenue-bar-chart', barChartData, barChartLayout, {responsive: true});
                console.log("Monthly revenue bar chart rendered.");
            } else {
                console.log("No monthly revenue data available for bar chart.");
                document.getElementById('monthly-revenue-bar-chart').innerHTML = '<p class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì</p>';
            }
        } catch(e) {
            console.error("Error rendering monthly revenue bar chart:", e);
        }
    });
</script>
{% endblock %}